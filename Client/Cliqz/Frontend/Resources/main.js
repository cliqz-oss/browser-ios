var window = {};
var System = {
register: function(name, params, f) {
	name = 'ytdownloader';
	window[name] = {};
	var exportfun = function(fname, impl) {
		window.ytdownloader[fname] = impl;
	};
	var res = f(exportfun);
	res.execute();
  }
};

System.register('yt-downloader/main', [], function (_export) {
  'use strict';

  /*
  This provides the downloadable link for youtube videos.
  Most of the regex and concepts have been picked up from https://github.com/gantt/downloadyoutube.
  
  The idea would be to move the patterns and other config to a web-service so that if patterns change we can easily update the changes.
  */

  var TITLE_REGEX, FORMAT_LABEL, FORMAT_TYPE, FORMAT_ORDER, FORMAT_RULE, SHOW_DASH_FORMATS;

  function findMatch(text, regexp) {
    var matches = text.match(regexp);
    return matches ? matches[1] : null;
  }

  function fetch_yt_url(youtube_url, callback) {
    
    var req = new XMLHttpRequest();
    req.open('GET', youtube_url, true);
    req.onreadystatechange = function () {
      if (req.readyState === 4 && req.status === 200) {
        callback(get_links(req.responseText, callback));
      } else if (req.readyState === 4) {
        callback('hello');
      }
    };
    req.send(null);
  }

  function getSeparators(videoFormats) {
    var sep1 = undefined,
        sep2 = undefined,
        sep3 = undefined;
    if (videoFormats.indexOf(',') > -1) {
      sep1 = ',';
      sep2 = videoFormats.indexOf('&') > -1 ? '&' : '\\u0026';
      sep3 = '=';
    } else {
      sep1 = '%2C';
      sep2 = '%26';
      sep3 = '%3D';
    }
    return { sep1: sep1, sep2: sep2, sep3: sep3 };
  }

  function get_links(bodyContent, callback) {
    var videoID = null,
        videoFormats = undefined,
        videoAdaptFormats = undefined,
        videoManifestURL = undefined;

    if (bodyContent !== null) {
      videoID = findMatch(bodyContent, /\"video_id\":\s*\"([^\"]+)\"/);
      videoFormats = findMatch(bodyContent, /\"url_encoded_fmt_stream_map\":\s*\"([^\"]+)\"/);
      videoAdaptFormats = findMatch(bodyContent, /\"adaptive_fmts\":\s*\"([^\"]+)\"/);
      videoManifestURL = findMatch(bodyContent, /\"dashmpd\":\s*\"([^\"]+)\"/);
    }

    var videoTitle = findMatch(bodyContent, TITLE_REGEX);
    videoTitle = videoTitle ? videoTitle : 'Youtube Video';

    // parse the formats map

    var _getSeparators = getSeparators(videoFormats);

    var sep1 = _getSeparators.sep1;
    var sep2 = _getSeparators.sep2;
    var sep3 = _getSeparators.sep3;

    var videoURL = [];
    var videoSignature = [];
    if (videoAdaptFormats) {
      videoFormats = videoFormats + sep1 + videoAdaptFormats;
    }

    var videoFormatsGroup = videoFormats.split(sep1);
    for (var i = 0; i < videoFormatsGroup.length; i++) {
      var videoFormatsElem = videoFormatsGroup[i].split(sep2);
      var videoFormatsPair = [];
      for (var j = 0; j < videoFormatsElem.length; j++) {
        var pair = videoFormatsElem[j].split(sep3);
        if (pair.length === 2) {
          videoFormatsPair[pair[0]] = pair[1];
        }
      }
      if (videoFormatsPair['url'] === null) {
        continue;
      }
      var url = unescape(unescape(videoFormatsPair['url'])).replace(/\\\//g, '/').replace(/\\u0026/g, '&');
      if (videoFormatsPair['itag'] === null) {
        continue;
      }
      var itag = videoFormatsPair['itag'];
      var sig = videoFormatsPair['sig'] || videoFormatsPair['signature'];
      if (sig) {
        url = url + '&signature=' + sig;
        videoSignature[itag] = null;
      } else if (videoFormatsPair['s']) {
        url = url + '&signature=' + videoFormatsPair['s'];
        videoSignature[itag] = videoFormatsPair['s'];
      }
      if (url.toLowerCase().indexOf('ratebypass') === -1) {
        // speed up download for dash
        url = url + '&ratebypass = yes';
      }
      if (url.toLowerCase().indexOf('http') === 0) {
        // validate URL
        videoURL[itag] = url + '&title=' + videoTitle;
      }
    }

    var showFormat = [];
    for (var category in FORMAT_RULE) {
      var rule = FORMAT_RULE[category];
      for (var index in FORMAT_TYPE) {
        if (FORMAT_TYPE[index] === category) {
          showFormat[index] = rule === 'all';
        }
      }
      if (rule === 'max') {
        for (var i = FORMAT_ORDER.length - 1; i >= 0; i--) {
          var format = FORMAT_ORDER[i];
          if (FORMAT_TYPE[format] === category && videoURL[format] !== undefined) {
            showFormat[format] = true;
            break;
          }
        }
      }
    }

    var downloadCodeList = [];
    for (var i = 0; i < FORMAT_ORDER.length; i++) {
      var format = FORMAT_ORDER[i];
      if (format === '37' && videoURL[format] === undefined) {
        // hack for dash 1080p
        if (videoURL['137']) {
          format = '137';
        }
        showFormat[format] = showFormat['37'];
      } else if (format === '38' && videoURL[format] === undefined) {
        // hack for dash 4K
        if (videoURL['138'] && !videoURL['266']) {
          format = '138';
        }
        showFormat[format] = showFormat['38'];
      }
      if (!SHOW_DASH_FORMATS && format.length > 2) {
        continue;
      }
      if (videoURL[format] !== undefined && FORMAT_LABEL[format] !== undefined && showFormat[format]) {
        downloadCodeList.push({ url: encodeURIComponent(videoURL[format]), sig: videoSignature[format], format: format, label: FORMAT_LABEL[format] });
        console.log('DYVAM - Info: itag' + format + ' url:' + videoURL[format]);
      }
    }

    if (downloadCodeList.length === 0) {
      console.log('No download URL found. Probably YouTube uses encrypted streams.');
    }
    return downloadCodeList;
  }

  return {
    setters: [],
    execute: function () {
      TITLE_REGEX = /<meta\s+name="title"\s+content="([^"]*)">/;
      FORMAT_LABEL = { '5': 'FLV 240p', '18': 'MP4 360p', '22': 'MP4 720p', '34': 'FLV 360p', '35': 'FLV 480p', '37': 'MP4 1080p', '38': 'MP4 2160p', '43': 'WebM 360p', '44': 'WebM 480p', '45': 'WebM 720p', '46': 'WebM 1080p', '135': 'MP4 480p - no audio', '137': 'MP4 1080p - no audio', '138': 'MP4 2160p - no audio', '139': 'M4A 48kbps - audio', '140': 'M4A 128kbps - audio', '141': 'M4A 256kbps - audio', '264': 'MP4 1440p - no audio', '266': 'MP4 2160p - no audio', '298': 'MP4 720p60 - no audio', '299': 'MP4 1080p60 - no audio' };
      FORMAT_TYPE = { '5': 'flv', '18': 'mp4', '22': 'mp4', '34': 'flv', '35': 'flv', '37': 'mp4', '38': 'mp4', '43': 'webm', '44': 'webm', '45': 'webm', '46': 'webm', '135': 'mp4', '137': 'mp4', '138': 'mp4', '139': 'm4a', '140': 'm4a', '141': 'm4a', '264': 'mp4', '266': 'mp4', '298': 'mp4', '299': 'mp4' };
      FORMAT_ORDER = ['5', '18', '34', '43', '35', '135', '44', '22', '298', '45', '37', '299', '46', '264', '38', '266', '139', '140', '141'];
      FORMAT_RULE = { 'flv': 'none', 'mp4': 'all', /*'webm': 'max',*/ 'm4a': 'max' };

      // all = display all versions, max = only highest quality version, none = no version
      // the default settings show all MP4 videos, the highest quality FLV and no WebM
      SHOW_DASH_FORMATS = false;

      _export('getUrls', fetch_yt_url);
    }
  };
});
//# sourceMappingURL=data:application/json;base64,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RUFBQyxXQUFXLEVBQUMsSUFBSSxFQUFDLFdBQVcsRUFBQyxJQUFJLEVBQUMsV0FBVyxFQUFDLElBQUksRUFBQyxXQUFXLEVBQUMsSUFBSSxFQUFDLFdBQVcsRUFBQyxJQUFJLEVBQUMsWUFBWSxFQUFDLEtBQUssRUFBQyxxQkFBcUIsRUFBQyxLQUFLLEVBQUMsc0JBQXNCLEVBQUMsS0FBSyxFQUFDLHNCQUFzQixFQUFDLEtBQUssRUFBQyxvQkFBb0IsRUFBQyxLQUFLLEVBQUMscUJBQXFCLEVBQUMsS0FBSyxFQUFDLHFCQUFxQixFQUFDLEtBQUssRUFBQyxzQkFBc0IsRUFBQyxLQUFLLEVBQUMsc0JBQXNCLEVBQUMsS0FBSyxFQUFDLHVCQUF1QixFQUFDLEtBQUssRUFBQyx3QkFBd0IsRUFBQztBQUN0ZSxpQkFBVyxHQUFHLEVBQUMsR0FBRyxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxJQUFJLEVBQUMsTUFBTSxFQUFDLElBQUksRUFBQyxNQUFNLEVBQUMsSUFBSSxFQUFDLE1BQU0sRUFBQyxJQUFJLEVBQUMsTUFBTSxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUM7QUFDblEsa0JBQVksR0FBRyxDQUFDLEdBQUcsRUFBQyxJQUFJLEVBQUMsSUFBSSxFQUFDLElBQUksRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxJQUFJLEVBQUMsS0FBSyxFQUFDLElBQUksRUFBQyxLQUFLLEVBQUMsSUFBSSxFQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssQ0FBQztBQUN0SCxpQkFBVyxHQUFHLEVBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxLQUFLLEVBQUMsS0FBSyxFQUFDLEtBQUssRUFBQzs7OztBQUdqRSx1QkFBaUIsR0FBRyxLQUFLOzt5QkFtSnRCLFlBQVkiLCJmaWxlIjoieXQtZG93bmxvYWRlci9tYWluLmVzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnO1xuXG4vKlxuVGhpcyBwcm92aWRlcyB0aGUgZG93bmxvYWRhYmxlIGxpbmsgZm9yIHlvdXR1YmUgdmlkZW9zLlxuTW9zdCBvZiB0aGUgcmVnZXggYW5kIGNvbmNlcHRzIGhhdmUgYmVlbiBwaWNrZWQgdXAgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vZ2FudHQvZG93bmxvYWR5b3V0dWJlLlxuXG5UaGUgaWRlYSB3b3VsZCBiZSB0byBtb3ZlIHRoZSBwYXR0ZXJucyBhbmQgb3RoZXIgY29uZmlnIHRvIGEgd2ViLXNlcnZpY2Ugc28gdGhhdCBpZiBwYXR0ZXJucyBjaGFuZ2Ugd2UgY2FuIGVhc2lseSB1cGRhdGUgdGhlIGNoYW5nZXMuXG4qL1xuXG5cbmNvbnN0IFRJVExFX1JFR0VYID0gLzxtZXRhXFxzK25hbWU9XCJ0aXRsZVwiXFxzK2NvbnRlbnQ9XCIoW15cIl0qKVwiPi9cbmNvbnN0IEZPUk1BVF9MQUJFTCA9IHsnNSc6J0ZMViAyNDBwJywnMTgnOidNUDQgMzYwcCcsJzIyJzonTVA0IDcyMHAnLCczNCc6J0ZMViAzNjBwJywnMzUnOidGTFYgNDgwcCcsJzM3JzonTVA0IDEwODBwJywnMzgnOidNUDQgMjE2MHAnLCc0Myc6J1dlYk0gMzYwcCcsJzQ0JzonV2ViTSA0ODBwJywnNDUnOidXZWJNIDcyMHAnLCc0Nic6J1dlYk0gMTA4MHAnLCcxMzUnOidNUDQgNDgwcCAtIG5vIGF1ZGlvJywnMTM3JzonTVA0IDEwODBwIC0gbm8gYXVkaW8nLCcxMzgnOidNUDQgMjE2MHAgLSBubyBhdWRpbycsJzEzOSc6J000QSA0OGticHMgLSBhdWRpbycsJzE0MCc6J000QSAxMjhrYnBzIC0gYXVkaW8nLCcxNDEnOidNNEEgMjU2a2JwcyAtIGF1ZGlvJywnMjY0JzonTVA0IDE0NDBwIC0gbm8gYXVkaW8nLCcyNjYnOidNUDQgMjE2MHAgLSBubyBhdWRpbycsJzI5OCc6J01QNCA3MjBwNjAgLSBubyBhdWRpbycsJzI5OSc6J01QNCAxMDgwcDYwIC0gbm8gYXVkaW8nfTtcbmNvbnN0IEZPUk1BVF9UWVBFID0geyc1JzonZmx2JywnMTgnOidtcDQnLCcyMic6J21wNCcsJzM0JzonZmx2JywnMzUnOidmbHYnLCczNyc6J21wNCcsJzM4JzonbXA0JywnNDMnOid3ZWJtJywnNDQnOid3ZWJtJywnNDUnOid3ZWJtJywnNDYnOid3ZWJtJywnMTM1JzonbXA0JywnMTM3JzonbXA0JywnMTM4JzonbXA0JywnMTM5JzonbTRhJywnMTQwJzonbTRhJywnMTQxJzonbTRhJywnMjY0JzonbXA0JywnMjY2JzonbXA0JywnMjk4JzonbXA0JywnMjk5JzonbXA0J307XG5jb25zdCBGT1JNQVRfT1JERVIgPSBbJzUnLCcxOCcsJzM0JywnNDMnLCczNScsJzEzNScsJzQ0JywnMjInLCcyOTgnLCc0NScsJzM3JywnMjk5JywnNDYnLCcyNjQnLCczOCcsJzI2NicsJzEzOScsJzE0MCcsJzE0MSddO1xuY29uc3QgRk9STUFUX1JVTEUgPSB7J2Zsdic6J25vbmUnLCdtcDQnOidhbGwnLCd3ZWJtJzonbWF4JywnbTRhJzonbWF4J307XG4vLyBhbGwgPSBkaXNwbGF5IGFsbCB2ZXJzaW9ucywgbWF4ID0gb25seSBoaWdoZXN0IHF1YWxpdHkgdmVyc2lvbiwgbm9uZSA9IG5vIHZlcnNpb25cbi8vIHRoZSBkZWZhdWx0IHNldHRpbmdzIHNob3cgYWxsIE1QNCB2aWRlb3MsIHRoZSBoaWdoZXN0IHF1YWxpdHkgRkxWIGFuZCBubyBXZWJNXG5jb25zdCBTSE9XX0RBU0hfRk9STUFUUyA9IGZhbHNlO1xuXG5mdW5jdGlvbiBmaW5kTWF0Y2godGV4dCwgcmVnZXhwKSB7XG4gICAgY29uc3QgbWF0Y2hlcyA9IHRleHQubWF0Y2gocmVnZXhwKTtcbiAgICByZXR1cm4gKG1hdGNoZXMpID8gbWF0Y2hlc1sxXSA6IG51bGw7XG59XG5cbmZ1bmN0aW9uIGZldGNoX3l0X3VybCh5b3V0dWJlX3VybCwgY2FsbGJhY2spIHtcbiAgaWYgKCFjYWxsYmFjaykge1xuICAgIGNhbGxiYWNrID0gb3NBUEkubm90aWZ5WW91dHViZVZpZGVvVXJscztcbiAgfVxuICBsZXQgcmVxID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gIHJlcS5vcGVuKCdHRVQnLCB5b3V0dWJlX3VybCwgdHJ1ZSk7XG4gIHJlcS5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHJlcS5yZWFkeVN0YXRlID09PSA0ICYmIHJlcS5zdGF0dXMgPT09IDIwMCkge1xuICAgICAgY2FsbGJhY2soZ2V0X2xpbmtzKHJlcS5yZXNwb25zZVRleHQpKTtcbiAgICB9IGVsc2UgaWYgKHJlcS5yZWFkeVN0YXRlID09PSA0KSB7XG4gICAgICBjYWxsYmFjayhbXSk7XG4gICAgfVxuICB9O1xuICByZXEuc2VuZChudWxsKTtcbn1cblxuZnVuY3Rpb24gZ2V0U2VwYXJhdG9ycyh2aWRlb0Zvcm1hdHMpIHtcbiAgbGV0IHNlcDEsIHNlcDIsIHNlcDM7XG4gIGlmICh2aWRlb0Zvcm1hdHMuaW5kZXhPZignLCcpID4gLTEpIHtcbiAgICBzZXAxID0gJywnO1xuICAgIHNlcDIgPSAodmlkZW9Gb3JtYXRzLmluZGV4T2YoJyYnKSA+IC0xKSA/ICcmJyA6ICdcXFxcdTAwMjYnO1xuICAgIHNlcDMgPSAnPSc7XG4gIH0gZWxzZSB7XG4gICAgc2VwMSA9ICclMkMnO1xuICAgIHNlcDIgPSAnJTI2JztcbiAgICBzZXAzID0gJyUzRCc7XG4gIH1cbiAgcmV0dXJuIHsgc2VwMSwgc2VwMiwgc2VwMyB9O1xufVxuXG5mdW5jdGlvbiBnZXRfbGlua3MoYm9keUNvbnRlbnQpIHtcbiAgbGV0IHZpZGVvSUQgPSBudWxsLFxuICAgICAgdmlkZW9Gb3JtYXRzLFxuICAgICAgdmlkZW9BZGFwdEZvcm1hdHMsXG4gICAgICB2aWRlb01hbmlmZXN0VVJMO1xuXG4gIGlmIChib2R5Q29udGVudCAhPT0gbnVsbCkge1xuICAgIHZpZGVvSUQgPSBmaW5kTWF0Y2goYm9keUNvbnRlbnQsIC9cXFwidmlkZW9faWRcXFwiOlxccypcXFwiKFteXFxcIl0rKVxcXCIvKTtcbiAgICB2aWRlb0Zvcm1hdHMgPSBmaW5kTWF0Y2goYm9keUNvbnRlbnQsIC9cXFwidXJsX2VuY29kZWRfZm10X3N0cmVhbV9tYXBcXFwiOlxccypcXFwiKFteXFxcIl0rKVxcXCIvKTtcbiAgICB2aWRlb0FkYXB0Rm9ybWF0cyA9IGZpbmRNYXRjaChib2R5Q29udGVudCwgL1xcXCJhZGFwdGl2ZV9mbXRzXFxcIjpcXHMqXFxcIihbXlxcXCJdKylcXFwiLyk7XG4gICAgdmlkZW9NYW5pZmVzdFVSTCA9IGZpbmRNYXRjaChib2R5Q29udGVudCwgL1xcXCJkYXNobXBkXFxcIjpcXHMqXFxcIihbXlxcXCJdKylcXFwiLyk7XG4gIH1cblxuICBsZXQgdmlkZW9UaXRsZSA9IGZpbmRNYXRjaChib2R5Q29udGVudCwgVElUTEVfUkVHRVgpO1xuICB2aWRlb1RpdGxlID0gKHZpZGVvVGl0bGUpID8gZXNjYXBlKHZpZGVvVGl0bGUpIDogZXNjYXBlKCdZb3V0dWJlIFZpZGVvJyk7XG5cbiAgLy8gcGFyc2UgdGhlIGZvcm1hdHMgbWFwXG4gIGNvbnN0IHsgc2VwMSwgc2VwMiwgc2VwMyB9ID0gZ2V0U2VwYXJhdG9ycyh2aWRlb0Zvcm1hdHMpO1xuICBcblxuICBsZXQgdmlkZW9VUkwgPSBbXTtcbiAgbGV0IHZpZGVvU2lnbmF0dXJlID0gW107XG4gIGlmICh2aWRlb0FkYXB0Rm9ybWF0cykge1xuICAgIHZpZGVvRm9ybWF0cyA9IHZpZGVvRm9ybWF0cyArIHNlcDEgKyB2aWRlb0FkYXB0Rm9ybWF0cztcbiAgfVxuXG4gIGxldCB2aWRlb0Zvcm1hdHNHcm91cCA9IHZpZGVvRm9ybWF0cy5zcGxpdChzZXAxKTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB2aWRlb0Zvcm1hdHNHcm91cC5sZW5ndGg7IGkrKykge1xuICAgIGxldCB2aWRlb0Zvcm1hdHNFbGVtID0gdmlkZW9Gb3JtYXRzR3JvdXBbaV0uc3BsaXQoc2VwMik7XG4gICAgbGV0IHZpZGVvRm9ybWF0c1BhaXIgPSBbXTtcbiAgICBmb3IgKGxldCBqID0gMDsgajx2aWRlb0Zvcm1hdHNFbGVtLmxlbmd0aDsgaisrKSB7XG4gICAgICBsZXQgcGFpciA9IHZpZGVvRm9ybWF0c0VsZW1bal0uc3BsaXQoc2VwMyk7XG4gICAgICBpZiAocGFpci5sZW5ndGggPT09IDIpIHtcbiAgICAgICAgdmlkZW9Gb3JtYXRzUGFpcltwYWlyWzBdXSA9IHBhaXJbMV07XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh2aWRlb0Zvcm1hdHNQYWlyWyd1cmwnXSA9PT0gbnVsbCkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGxldCB1cmwgPSB1bmVzY2FwZSh1bmVzY2FwZSh2aWRlb0Zvcm1hdHNQYWlyWyd1cmwnXSkpLnJlcGxhY2UoL1xcXFxcXC8vZywnLycpLnJlcGxhY2UoL1xcXFx1MDAyNi9nLCcmJyk7XG4gICAgaWYgKHZpZGVvRm9ybWF0c1BhaXJbJ2l0YWcnXSA9PT0gbnVsbCkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGxldCBpdGFnID0gdmlkZW9Gb3JtYXRzUGFpclsnaXRhZyddO1xuICAgIGxldCBzaWcgPSB2aWRlb0Zvcm1hdHNQYWlyWydzaWcnXXx8dmlkZW9Gb3JtYXRzUGFpclsnc2lnbmF0dXJlJ107XG4gICAgaWYgKHNpZykge1xuICAgICAgdXJsID0gdXJsKycmc2lnbmF0dXJlPScgKyBzaWc7XG4gICAgICB2aWRlb1NpZ25hdHVyZVtpdGFnXSA9IG51bGw7XG4gICAgfVxuICAgIGVsc2UgaWYgKHZpZGVvRm9ybWF0c1BhaXJbJ3MnXSkge1xuICAgICAgdXJsID0gdXJsKycmc2lnbmF0dXJlPScgKyB2aWRlb0Zvcm1hdHNQYWlyWydzJ107XG4gICAgICB2aWRlb1NpZ25hdHVyZVtpdGFnXSA9IHZpZGVvRm9ybWF0c1BhaXJbJ3MnXTtcbiAgICB9XG4gICAgaWYgKHVybC50b0xvd2VyQ2FzZSgpLmluZGV4T2YoJ3JhdGVieXBhc3MnKSA9PT0gLTEpIHsgLy8gc3BlZWQgdXAgZG93bmxvYWQgZm9yIGRhc2hcbiAgICAgIHVybCA9IHVybCsnJnJhdGVieXBhc3MgPSB5ZXMnO1xuICAgIH1cbiAgICBpZiAodXJsLnRvTG93ZXJDYXNlKCkuaW5kZXhPZignaHR0cCcpID09PSAwKSB7IC8vIHZhbGlkYXRlIFVSTFxuICAgICAgdmlkZW9VUkxbaXRhZ10gPSB1cmwgKyAnJnRpdGxlPScgKyB2aWRlb1RpdGxlO1xuICAgIH1cbiAgfVxuXG4gIGxldCBzaG93Rm9ybWF0ID0gW107XG4gIGZvciAobGV0IGNhdGVnb3J5IGluIEZPUk1BVF9SVUxFKSB7XG4gICAgY29uc3QgcnVsZSA9IEZPUk1BVF9SVUxFW2NhdGVnb3J5XTtcbiAgICBmb3IgKGxldCBpbmRleCBpbiBGT1JNQVRfVFlQRSl7XG4gICAgICBpZiAoRk9STUFUX1RZUEVbaW5kZXhdID09PSBjYXRlZ29yeSkge1xuICAgICAgICBzaG93Rm9ybWF0W2luZGV4XSA9IChydWxlID09PSAnYWxsJyk7XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChydWxlID09PSAnbWF4Jykge1xuICAgICAgZm9yIChsZXQgaSA9IEZPUk1BVF9PUkRFUi5sZW5ndGgtMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgbGV0IGZvcm1hdCA9IEZPUk1BVF9PUkRFUltpXTtcbiAgICAgICAgaWYgKEZPUk1BVF9UWVBFW2Zvcm1hdF0gPT09IGNhdGVnb3J5ICYmIHZpZGVvVVJMW2Zvcm1hdF0gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHNob3dGb3JtYXRbZm9ybWF0XSA9IHRydWU7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBsZXQgZG93bmxvYWRDb2RlTGlzdCA9IFtdO1xuICBmb3IgKGxldCBpID0gMDsgaSA8IEZPUk1BVF9PUkRFUi5sZW5ndGg7IGkrKykge1xuICAgIGxldCBmb3JtYXQgPSBGT1JNQVRfT1JERVJbaV07XG4gICAgaWYgKGZvcm1hdCA9PT0gJzM3JyAmJiB2aWRlb1VSTFtmb3JtYXRdID09PSB1bmRlZmluZWQpIHsgLy8gaGFjayBmb3IgZGFzaCAxMDgwcFxuICAgICAgaWYgKHZpZGVvVVJMWycxMzcnXSkge1xuICAgICAgIGZvcm1hdCA9ICcxMzcnO1xuICAgICAgfVxuICAgICAgc2hvd0Zvcm1hdFtmb3JtYXRdID0gc2hvd0Zvcm1hdFsnMzcnXTtcbiAgICB9IGVsc2UgaWYgKGZvcm1hdCA9PT0gJzM4JyAmJiB2aWRlb1VSTFtmb3JtYXRdID09PSB1bmRlZmluZWQpIHsgLy8gaGFjayBmb3IgZGFzaCA0S1xuICAgICAgaWYgKHZpZGVvVVJMWycxMzgnXSAmJiAhdmlkZW9VUkxbJzI2NiddKSB7XG4gICAgICAgIGZvcm1hdD0nMTM4JztcbiAgICAgIH1cbiAgICAgIHNob3dGb3JtYXRbZm9ybWF0XSA9IHNob3dGb3JtYXRbJzM4J107XG4gICAgfVxuICAgIGlmICghU0hPV19EQVNIX0ZPUk1BVFMgJiYgZm9ybWF0Lmxlbmd0aD4yKSB7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgaWYgKHZpZGVvVVJMW2Zvcm1hdF0gIT09IHVuZGVmaW5lZCAmJiBGT1JNQVRfTEFCRUxbZm9ybWF0XSAhPT0gdW5kZWZpbmVkICYmIHNob3dGb3JtYXRbZm9ybWF0XSkge1xuICAgICAgZG93bmxvYWRDb2RlTGlzdC5wdXNoKHt1cmw6dmlkZW9VUkxbZm9ybWF0XSxzaWc6dmlkZW9TaWduYXR1cmVbZm9ybWF0XSxmb3JtYXQ6Zm9ybWF0LGxhYmVsOkZPUk1BVF9MQUJFTFtmb3JtYXRdfSk7XG4gICAgICBjb25zb2xlLmxvZygnRFlWQU0gLSBJbmZvOiBpdGFnJytmb3JtYXQrJyB1cmw6Jyt2aWRlb1VSTFtmb3JtYXRdKTtcbiAgICB9XG4gIH1cblxuICBpZiAoZG93bmxvYWRDb2RlTGlzdC5sZW5ndGggPT09IDApIHtcbiAgICBjb25zb2xlLmxvZygnTm8gZG93bmxvYWQgVVJMIGZvdW5kLiBQcm9iYWJseSBZb3VUdWJlIHVzZXMgZW5jcnlwdGVkIHN0cmVhbXMuJyk7XG4gIH1cbiAgcmV0dXJuIGRvd25sb2FkQ29kZUxpc3Q7XG59XG5cblxuZXhwb3J0IHsgZmV0Y2hfeXRfdXJsIGFzIGdldFVybHMgfTtcbiJdfQ==
